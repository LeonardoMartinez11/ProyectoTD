name: CI LoginController

on:
  push:
    branches:
      - main

jobs:
  test-logincontroller:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Instalar extensiones PHP necesarias
        run: |
          sudo apt-get update
          sudo apt-get install -y php-curl php-xml php-mbstring

      - name: Crear archivo de prueba test_controller.php
        run: |
          echo "<?php
          \$datos_json = json_encode([
              'usuario' => 'Leo3',
              'contrasena' => '12345'
          ]);

          // Simula php://input
          \$GLOBALS['input'] = \$datos_json;
          class VariableStream {
              var \$position;
              var \$varname;
              function stream_open(\$path, \$mode, \$options, &\$opened_path) {
                  \$url = parse_url(\$path);
                  \$this->varname = 'input';
                  \$this->position = 0;
                  return true;
              }
              function stream_read(\$count) {
                  \$ret = substr(\$GLOBALS[\$this->varname], \$this->position, \$count);
                  \$this->position += strlen(\$ret);
                  return \$ret;
              }
              function stream_eof() {
                  return \$this->position >= strlen(\$GLOBALS[\$this->varname]);
              }
              function stream_stat() {
                  return [];
              }
          }

          stream_wrapper_unregister('php');
          stream_wrapper_register('php', 'VariableStream');

          require getcwd() . '/controlador/LoginController.php';
          " > test_controller.php

      - name: Ejecutar test LoginController
        run: php test_controller.php
